# Story 4.1 — Setup Jest + Supertest no Backend

**Status:** Done
**Epic:** Cobertura de Testes
**Priority:** P2

## Descrição
Como desenvolvedor, quero configurar Jest e Supertest no backend para que a equipe possa escrever e executar testes automatizados de forma padronizada.

## Contexto Técnico
O backend não possui nenhuma configuração de testes. O projeto usa TypeScript 5+, Express 4, Prisma 5 e `tsx` para execução em desenvolvimento. Não há `jest`, `ts-jest`, `supertest` ou arquivos de configuração de testes.

Pacotes a instalar (backend devDependencies):
- `jest@^29.7.0`
- `ts-jest@^29.2.0`
- `supertest@^7.0.0`
- `@types/jest@^29.5.0`
- `@types/supertest@^6.0.0`

Banco de testes: usar banco PostgreSQL separado via variável de ambiente `DATABASE_URL_TEST`. Em CI/ambientes sem banco disponível, considerar mock do Prisma client. Para a entrega mínima desta story (smoke test), mockar o Prisma é aceitável.

O `server.ts` deve exportar o `app` do Express separado do `listen()` para permitir que o Supertest suba o servidor sem conflito de porta.

## Escopo

### IN
- [x] Instalar `jest`, `ts-jest`, `supertest`, `@types/jest`, `@types/supertest` como devDependencies
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\backend\jest.config.ts` com:
  - `preset: 'ts-jest'`
  - `testEnvironment: 'node'`
  - `roots: ['<rootDir>/src']`
  - `testMatch: ['**/__tests__/**/*.test.ts']`
  - `moduleNameMapper` para paths do TypeScript (`@/*` → `src/*`)
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\setup.ts` com:
  - Setup global: desconectar Prisma client após todos os testes (`afterAll`)
  - Variável `DATABASE_URL` apontando para banco de teste
- [x] Garantir que `backend/src/server.ts` exporte `app` e chame `app.listen()` separadamente (refatorar se necessário)
- [x] Adicionar scripts no `package.json`:
  - `"test": "jest"`
  - `"test:watch": "jest --watch"`
  - `"test:coverage": "jest --coverage"`
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\smoke.test.ts`:
  - Teste: `GET /api/health` retorna status 200 e `{ status: 'ok' }` (ou adaptar para o endpoint de healthcheck existente)
  - Se não houver endpoint de health, criar `GET /api/health` em `server.ts`
- [x] Adicionar `C:\Users\MARCELO SANTOS\Desktop\test\backend\.env.test` ao `.gitignore` (não commitar)

### OUT
- Configuração de banco de testes separado com migrations automáticas (Story 4.2 define estratégia de mock)
- Testes dos módulos de negócio (Story 4.2)
- Cobertura de código (pode ser ativada mas não é meta desta story)

## Critérios de Aceitação
- [x] AC1: Dado que o desenvolvedor executa `npm run test` no diretório `backend/`, então o Jest encontra e executa `smoke.test.ts` e todos os testes passam (verde)
- [x] AC2: Dado que o Jest executa, então `ts-jest` compila os arquivos TypeScript sem erros de type-checking
- [x] AC3: Dado que `smoke.test.ts` faz uma requisição para `GET /api/health`, então o Supertest recebe status 200
- [x] AC4: Dado que `npm run test:watch` é executado, então o Jest entra em modo watch e reexecuta testes ao salvar arquivos
- [x] AC5: O `package.json` do backend possui os scripts `test`, `test:watch` e `test:coverage`

## Dependências
Nenhuma (pode rodar em paralelo com Epics 2 e 3).

## Arquivos Afetados
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\package.json` — novos scripts e devDependencies
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\jest.config.ts` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\setup.ts` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\smoke.test.ts` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\server.ts` — refatorar export do app (se necessário)
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\.gitignore` — adicionar .env.test

## Estimativa
M

## Change Log
- 2026-02-27: Story criada por @sm
- 2026-02-27: Validado por @po — GO 8/10. Status: Ready.
- 2026-02-27: Implementado por @dev (Dex). Pacotes instalados, jest.config.ts criado, setup.ts e smoke.test.ts criados, scripts adicionados ao package.json, .env.test adicionado ao .gitignore. server.ts já exportava app separado do listen(). Status: InProgress.
- 2026-02-27: QA Gate executado por @qa (Quinn). Verdict: PASS. 7/7 checks OK. 1 issue LOW (open handles warning). Status: Done.
