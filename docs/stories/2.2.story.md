# Story 2.2 — Drag entre Colunas com Update de Status via API

**Status:** InReview
**Epic:** Kanban Drag-and-Drop
**Priority:** P1

## Descrição
Como usuário da agência, quero arrastar um card de tarefa entre as colunas do Kanban para que o status da tarefa seja atualizado automaticamente no banco de dados sem precisar abrir um modal.

## Contexto Técnico
Com a infraestrutura de @dnd-kit configurada pela Story 2.1, esta story implementa a lógica de negócio no handler `onDragEnd`.

O endpoint já existe no backend: `PATCH /api/tasks/:id/status` — espera body `{ status: "TODO" | "IN_PROGRESS" | "DONE" }`.

O mapeamento de ID de coluna para enum já está definido no array `columns` em `tasks/page.tsx`:
```typescript
const columns = [
  { id: 'TODO', ... },
  { id: 'IN_PROGRESS', ... },
  { id: 'DONE', ... },
]
```
O ID da coluna destino vinda do `onDragEnd` (`over.id`) já corresponde diretamente ao valor do enum — sem transformação necessária.

## Escopo

### IN
- [x] Implementar handler `onDragEnd` no `DndContext`: extrair `active.id` (taskId) e `over?.id` (coluna destino)
- [x] Verificar se `over` é nulo ou se a coluna destino é igual à coluna de origem — se sim, retornar sem ação
- [x] Chamar `api.patch(`/tasks/${taskId}/status`, { status: novoStatus })` ao soltar em nova coluna
- [x] Aplicar feedback visual durante o drag: coluna destino com borda destacada (`isOver` do `useDroppable`), card sendo arrastado com opacidade reduzida (via `isDragging` do `useDraggable`)
- [x] Exibir `toast` de sucesso ao atualizar o status
- [x] Exibir `toast` de erro se a API retornar falha (sem rollback ainda — isso é Story 2.3)
- [x] Desabilitar o drag (pointer-events-none) em tasks com status undefined ou inválido

### OUT
- Atualização otimista do estado local (Story 2.3)
- Rollback em caso de erro (Story 2.3)
- Reordenação dentro da mesma coluna

## Critérios de Aceitação
- [x] AC1: Dado que o usuário solta um card na coluna "Concluído", quando a API retorna 200, então o card permanece na nova coluna e um toast de sucesso é exibido
- [x] AC2: Dado que o usuário solta o card na mesma coluna de origem, então `PATCH /api/tasks/:id/status` não é chamado
- [x] AC3: Dado que o usuário arrasta um card sobre uma coluna, quando o card está sobre ela, então a coluna exibe borda destacada (via `isOver`)
- [x] AC4: Dado que a API retorna erro (4xx/5xx), então um toast de erro é exibido e o card permanece onde foi solto (sem rollback — isso é Story 2.3)
- [x] AC5: Os filtros de busca por texto continuam funcionando após um drag bem-sucedido

## Dependências
Story 2.1 — Setup @dnd-kit/core (DndContext, KanbanColumn, TaskCard já implementados).

## Arquivos Afetados
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\app\(dashboard)\tasks\page.tsx` — handler onDragEnd
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\components\tasks\KanbanColumn.tsx` — estilo isOver
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\components\tasks\TaskCard.tsx` — estilo isDragging
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\lib\api.ts` — uso do método patch existente

## Estimativa
M

## Change Log
- 2026-02-27: Story criada por @sm
- 2026-02-27: Validado por @po — GO 8/10. Status: Ready.
- 2026-02-27: Implementado por @dev. Status: InReview.
