# Story 1.3 — Corrigir middleware.ts para validação consistente

**Status:** InReview
**Epic:** Epic 1 — Correção Crítica de Autenticação
**Priority:** P0

## Descrição
Como usuário da plataforma, quero que as rotas protegidas e públicas sejam gerenciadas de forma confiável pelo middleware do Next.js para que não ocorram loops de redirect nem acessos indevidos.

## Contexto Técnico

### Estado atual do arquivo
**`frontend/src/middleware.ts` (arquivo completo):**
```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

const publicPaths = ['/login', '/register'];

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  const token = request.cookies.get('token')?.value;   // linha 7

  if (pathname === '/') {
    const target = token ? '/dashboard' : '/login';
    return NextResponse.redirect(new URL(target, request.url));
  }

  if (publicPaths.some((path) => pathname.startsWith(path))) {
    if (token) {
      return NextResponse.redirect(new URL('/dashboard', request.url));
    }
    return NextResponse.next();
  }

  if (!token) {
    return NextResponse.redirect(new URL('/login', request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

### Problema a resolver após Story 1.1 e 1.2
Após as Stories 1.1 e 1.2, a variável local `token` deveria ser renomeada para `accessToken` para refletir a semântica correta (diferenciando entre access token, que tem 15 min de validade, e refresh token, que tem 30 dias).

**Nota importante sobre o nome do cookie:** O cookie de acesso permanece nomeado `'token'` (não foi renomeado para `'access_token'`) por compatibilidade com o middleware do Next.js. Isso foi definido na Story 1.2 (implementação). Portanto, a linha 7 continua a ler `request.cookies.get('token')`, mas agora armazena o valor na variável `accessToken` para clareza semântica.

Adicionalmente, há dois problemas de robustez que podem ser revisados:

1. **Ausência de proteção de sub-rotas do dashboard:** O matcher atual captura tudo exceto `api|_next/static|_next/image|favicon.ico`, o que é correto, e a lógica de proteção trata corretamente o prefixo `/dashboard` — funciona por exclusão (qualquer path não público sem token redireciona para login).

3. **Edge runtime e validação criptográfica:** O Next.js middleware roda no Edge Runtime, que suporta `jose` (não `jsonwebtoken`). A validação criptográfica do JWT (verificar assinatura) é tecnicamente viável com `jose`, mas está fora do escopo desta story conforme definido no PRD. O middleware deve checar apenas a **presença** do cookie `access_token`, não verificar sua assinatura — o backend valida criptograficamente em cada requisição de API.

4. **Loop potencial com `(dashboard)/layout.tsx`:** Antes da Story 1.1, o `layout.tsx` também verificava `localStorage.getItem('token')` (linha 15) e fazia redirect manual. Após a Story 1.1 essa verificação é removida do layout — o middleware passa a ser a única camada de proteção de rota no frontend, eliminando o risco de conflito.

### Dependência de Story 1.1
O cookie que o middleware precisa ler (`access_token`) só existe após a Story 1.1 estar concluída. Executar esta story antes da 1.1 resultará em todos os usuários sendo redirecionados para `/login`.

## Escopo

### IN (o que fazer)
- [x] **`frontend/src/middleware.ts`:** Renomear a variável local de `token` para `accessToken` para refletir a nomenclatura correta após Story 1.2
- [x] **`frontend/src/middleware.ts`:** Garantir que o bloco de rotas públicas (`/login`, `/register`) redirecione para `/dashboard` quando `accessToken` estiver presente (comportamento já existe, apenas atualizar o nome da variável)
- [x] **`frontend/src/middleware.ts`:** Garantir que o bloco de rotas protegidas redirecione para `/login` quando `accessToken` estiver ausente (comportamento já existe, apenas atualizar o nome da variável)
- [x] **`frontend/src/middleware.ts`:** Adicionar `/` (root) ao tratamento explícito — já existe, confirmar que continua correto
- [x] **`frontend/src/middleware.ts`:** Revisar e manter o `config.matcher` atual — está correto, não alterar
- [ ] **Teste manual obrigatório** dos 4 cenários (ver ACs abaixo) antes de marcar a story como concluída

### OUT (o que NÃO fazer nesta story)
- Implementar validação criptográfica do JWT no middleware com `jose` (viabilidade confirmada no PRD como fora do escopo)
- Alterar qualquer outro arquivo além de `frontend/src/middleware.ts`
- Criar testes automatizados (não há setup de testes neste projeto atualmente)
- Adicionar middleware de logging ou analytics
- Implementar rotas públicas adicionais além de `/login` e `/register`

## Critérios de Aceitação
- [ ] **AC1 — Login fresh:** Dado que o usuário não tem cookie `access_token`, quando acessa `/dashboard` diretamente, então é redirecionado para `/login` sem loop
- [ ] **AC2 — Usuário autenticado em rota pública:** Dado que o usuário tem cookie `access_token` válido (presente), quando acessa `/login` ou `/register`, então é redirecionado para `/dashboard` sem loop
- [ ] **AC3 — Token expirado (acesso direto):** Dado que o cookie `access_token` expirou e foi removido pelo browser, quando o usuário tenta acessar `/dashboard`, então é redirecionado para `/login` — o interceptor Axios da Story 1.2 lida com o refresh em chamadas de API, mas no acesso direto via browser o middleware captura corretamente
- [ ] **AC4 — Logout e acesso posterior:** Dado que o usuário fez logout (cookies limpos pela Story 1.1), quando tenta acessar qualquer rota do dashboard, então é redirecionado para `/login`
- [ ] **AC5 — Root path:** Dado que o usuário acessa `/`, quando tem `access_token` então vai para `/dashboard`; quando não tem, vai para `/login`
- [ ] **AC6 — Nenhum loop de redirect:** Em nenhum dos cenários acima o browser entra em loop de redirects (verificar via Network tab do DevTools — máximo 1 redirect por navegação)

## Dependências
**Story 1.1 deve estar concluída** — o cookie `access_token` deve existir antes de ativar esta mudança no middleware. Aplicar esta story antes da 1.1 derrubará a autenticação de todos os usuários.

## Arquivos Afetados
```
frontend/src/middleware.ts   — único arquivo modificado nesta story
```

## Estimativa
P (Pequeno)

## Change Log
- 2026-02-27: Story criada por @sm
- 2026-02-27: Validação PO concluída por @po — Score 9/10, veredicto GO, status alterado para Ready
- 2026-02-27: Implementação concluída por @dev — status alterado para InReview
  - Renomeada variável `token` para `accessToken` em todas as referências no middleware
  - Verificado que leitura do cookie permanece como `request.cookies.get('token')` por compatibilidade com Story 1.2
  - Confirmado que proteção de rotas públicas e protegidas funciona corretamente
  - Confirmado que tratamento do root path `/` funciona corretamente
  - Confirmado que `config.matcher` está correto
