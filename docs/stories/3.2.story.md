# Story 3.2 — Export PDF para Fatura (Invoice)

**Status:** InReview
**Epic:** Exportação de Dados (PDF/CSV)
**Priority:** P1

## Descrição
Como administrador ou gerente da agência, quero gerar e baixar um PDF da fatura para que eu possa enviá-lo ao cliente de forma profissional.

## Contexto Técnico
O módulo de finance possui `FinanceController` com `findInvoiceById` que retorna uma fatura com todos os dados relacionados (cliente, itens, total, status, data de vencimento).

Esta story cria o `pdf.service.ts` — utilitário compartilhado de geração de PDF que será reusado pela Story 3.3 (budgets). A biblioteca recomendada é `pdfkit@^0.15.0` (mais leve, sem dependência de React).

Pacotes a instalar (backend):
- `pdfkit@^0.15.0`
- `@types/pdfkit@^0.13.4` (devDependency)

O PDF é retornado como stream (`res.setHeader('Content-Type', 'application/pdf')`) diretamente da API — sem salvar arquivo em disco.

Proteção de role: retornar 403 para `MEMBER`.

## Escopo

### IN
- [x] Instalar `pdfkit` e `@types/pdfkit` no backend
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\finance\pdf.service.ts` com:
  - Função `generateInvoicePdf(invoice: InvoiceWithRelations): Promise<Buffer>` — retorna buffer do PDF
  - Função `generateBudgetPdf(budget: BudgetWithRelations): Promise<Buffer>` — stub a ser implementado em Story 3.3 (pode ser placeholder que lança NotImplemented)
  - Helper privado `createPdfDocument()` — configurações base (tamanho A4, margens, fontes)
- [x] Layout do PDF de fatura:
  - Cabeçalho: logo placeholder (texto "AGÊNCIA" estilizado), número da fatura, data de emissão
  - Dados do cliente: nome, email, empresa (se existir)
  - Tabela de itens: descrição, quantidade, valor unitário, subtotal
  - Total: subtotal, impostos (se houver), total final em destaque
  - Rodapé: status da fatura, data de vencimento, instrução de pagamento
- [x] Novo método `exportInvoicePdf` em `finance.controller.ts`
- [x] Nova rota `GET /api/finance/invoices/:id/pdf` em `finance.routes.ts`
- [x] Frontend: botão "Baixar PDF" na listagem de faturas (ação por linha) e na página de detalhe da fatura

### OUT
- Layout com imagem de logo real (usar texto placeholder)
- Assinatura digital do PDF
- Envio do PDF por email
- Implementação de `generateBudgetPdf` (Story 3.3)

## Critérios de Aceitação
- [x] AC1: Dado que um ADMIN chama `GET /api/finance/invoices/:id/pdf`, então a resposta tem `Content-Type: application/pdf` e `Content-Disposition: attachment; filename="fatura-<id>.pdf"`
- [x] AC2: Dado que o PDF é aberto, então contém: nome do cliente, lista de itens com valores, total da fatura e data de vencimento
- [x] AC3: Dado que a fatura não existe, então a API retorna 404
- [x] AC4: Dado que um MEMBER chama o endpoint, então a API retorna 403
- [x] AC5: Dado que o usuário clica em "Baixar PDF" na listagem de faturas, então o browser faz download do arquivo `.pdf` sem navegar para nova página
- [x] AC6: O `pdf.service.ts` exporta funções reutilizáveis compatíveis com a Story 3.3

## Dependências
Nenhuma dentro do Epic 3 (Story 3.3 depende desta).

## Arquivos Afetados
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\package.json` — adicionar pdfkit, @types/pdfkit
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\finance\pdf.service.ts` — NOVO arquivo (utilitário compartilhado)
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\finance\finance.controller.ts` — novo método exportInvoicePdf
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\finance\finance.routes.ts` — nova rota GET /invoices/:id/pdf
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\app\(dashboard)\finance\page.tsx` — botão "Baixar PDF" na listagem
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\app\(dashboard)\finance\[id]\page.tsx` — botão "Baixar PDF" no detalhe (se o arquivo existir)

## Estimativa
G

## Change Log
- 2026-02-27: Story criada por @sm
- 2026-02-27: Validado por @po — GO 9/10. Status: Ready.
- 2026-02-27: Implementado por @dev — pdfkit instalado, pdf.service.ts criado, rota e controller atualizados, botão "Baixar PDF" adicionado ao frontend. TypeScript compila sem erros. Status: InReview.
