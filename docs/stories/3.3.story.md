# Story 3.3 — Export PDF para Orçamento (Budget)

**Status:** Done
**Epic:** Exportação de Dados (PDF/CSV)
**Priority:** P1

## Descrição
Como administrador ou gerente da agência, quero gerar e baixar um PDF do orçamento para que eu possa enviá-lo ao cliente para aprovação comercial.

## Contexto Técnico
O `pdf.service.ts` foi criado na Story 3.2 com a função `generateBudgetPdf(budget: BudgetWithRelations)` como stub. Esta story implementa essa função.

O módulo de finance possui `FinanceController` com `findBudgetById` que retorna um orçamento com dados relacionados (cliente, itens, validade). O padrão de implementação deve espelhar `exportInvoicePdf` da Story 3.2 para manter consistência.

Budget tem status: `DRAFT | SENT | APPROVED | REJECTED`. O PDF deve ser gerado para qualquer status.

Sem instalar novos pacotes — `pdfkit` já estará instalado pela Story 3.2.

## Escopo

### IN
- [x] Implementar `generateBudgetPdf(budget: BudgetWithRelations): Promise<Buffer>` no `pdf.service.ts` existente (substituir o stub da Story 3.2)
- [x] Layout do PDF de orçamento:
  - Cabeçalho: logo placeholder, número do orçamento, data de emissão
  - Dados do cliente: nome, email, empresa
  - Tabela de itens: descrição, quantidade, valor unitário, subtotal por item
  - Totais: subtotal, desconto (se houver), total final em destaque
  - Rodapé: validade do orçamento (`validUntil`), status atual, instrução de aprovação ("Para aprovar, responda este email" ou similar)
- [x] Novo método `exportBudgetPdf` em `finance.controller.ts`
- [x] Nova rota `GET /api/finance/budgets/:id/pdf` em `finance.routes.ts`
- [x] Frontend: botão "Baixar PDF" na página de detalhe do orçamento

### OUT
- Reuso do mesmo template visual da fatura (os dois documentos têm estruturas distintas)
- Assinatura digital
- Geração de link de aprovação online

## Critérios de Aceitação
- [x] AC1: Dado que um ADMIN chama `GET /api/finance/budgets/:id/pdf`, então a resposta tem `Content-Type: application/pdf` e `Content-Disposition: attachment; filename="orcamento-<id>.pdf"`
- [x] AC2: Dado que o PDF é aberto, então contém: nome do cliente, itens com valores unitários e subtotais, total e data de validade do orçamento
- [x] AC3: Dado que o orçamento não existe, então a API retorna 404
- [x] AC4: Dado que um MEMBER chama o endpoint, então a API retorna 403
- [x] AC5: Dado que o usuário clica em "Baixar PDF" na página de detalhe do orçamento, então o browser faz download do arquivo `.pdf`
- [x] AC6: O `pdf.service.ts` não duplica código de layout entre `generateInvoicePdf` e `generateBudgetPdf` — helpers de formatação são compartilhados (ex: `formatCurrency`, `drawTable`, `drawHeader`)

## Dependências
Story 3.2 — Export PDF para Fatura (cria `pdf.service.ts` com `pdfkit` instalado e a estrutura base do PDF).

## Arquivos Afetados
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\finance\pdf.service.ts` — implementar generateBudgetPdf (substituir stub)
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\finance\finance.controller.ts` — novo método exportBudgetPdf
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\finance\finance.routes.ts` — nova rota GET /budgets/:id/pdf
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\app\(dashboard)\finance\budgets\[id]\page.tsx` — botão "Baixar PDF" (criar página se não existir)

## Estimativa
M

## Change Log
- 2026-02-27: Story criada por @sm
- 2026-02-27: Validado por @po — GO 9/10. Status: Ready.
- 2026-02-27: Implementado por @dev — Status: InReview.
  - `pdf.service.ts`: stub substituído por implementação completa de `generateBudgetPdf`; adicionado `BudgetItem` interface e helper `statusLabelBudget`; helpers `formatCurrency`, `formatDate`, `createPdfDocument` compartilhados com `generateInvoicePdf` (AC6)
  - `finance.controller.ts`: novo método `exportBudgetPdf` com 404 propagation
  - `finance.routes.ts`: nova rota `GET /budgets/:id/pdf` com `requireRole('ADMIN', 'MANAGER')` (AC4)
  - `frontend/finance/page.tsx`: `downloadBudgetPdf()` fetch-as-blob + botão "PDF" com `FileDown` icon em cada linha da tabela de orçamentos (AC5)
