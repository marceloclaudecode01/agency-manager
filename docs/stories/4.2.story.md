# Story 4.2 — Testes Unitários dos Services Críticos (auth, clients, finance)

**Status:** Done
**Epic:** Cobertura de Testes
**Priority:** P2

## Descrição
Como desenvolvedor, quero testes unitários nos services de auth, clients e finance para que regressões nos fluxos críticos sejam detectadas antes de chegar em produção.

## Contexto Técnico
Com o Jest configurado (Story 4.1), esta story escreve testes unitários dos services. A estratégia é mockar o Prisma client para que os testes não dependam de banco de dados.

Mock do Prisma: usar `jest.mock()` para substituir `src/config/database.ts` (singleton) com um objeto que retorna mocks das operações (`findUnique`, `create`, `findMany`, etc).

Estrutura dos services existentes (inferida do padrão de módulos):
- `backend/src/modules/auth/auth.service.ts` — métodos: `register()`, `login()`
- `backend/src/modules/clients/clients.service.ts` — métodos: `create()`, `findAll()`, `delete()`
- `backend/src/modules/finance/finance.service.ts` — métodos: `createInvoice()`, `getSummary()`

O `auth.service.ts` usa `bcryptjs` para hash de senhas e `jsonwebtoken` para gerar tokens — ambos reais (sem mock), pois são operações puras.

## Escopo

### IN
- [x] Criar mock helper `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\mocks\prisma.mock.ts` que exporta um objeto `prismaMock` com todos os métodos necessários como `jest.fn()`
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\auth.service.test.ts`:
  - `register()` — cria usuário: mock `prisma.user.findUnique` retorna null, mock `prisma.user.create` retorna usuário com id, verificar que senha armazenada é hash (não plaintext), verificar que retorna token JWT válido
  - `login()` com senha correta — mock `prisma.user.findUnique` retorna usuário com hash válido, verificar que retorna token
  - `login()` com senha errada — verificar que lança erro 401
  - `login()` com email inexistente — mock retorna null, verificar que lança erro 401
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\clients.service.test.ts`:
  - `create()` — mock `prisma.client.create`, verificar que `createdById` é passado corretamente
  - `findAll()` com filtro de status — mock `prisma.client.findMany`, verificar que where clause contém o status
  - `findAll()` com busca por nome — verificar que where clause usa `contains` (case insensitive)
  - `delete()` — mock `prisma.client.delete`, verificar que chama com o id correto
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\finance.service.test.ts`:
  - `createInvoice()` a partir de Budget com status APPROVED — mock retorna budget APPROVED, verificar criação da invoice
  - `createInvoice()` a partir de Budget com status DRAFT — verificar que lança erro (se essa regra existir no service)
  - `getSummary()` — mock dados de invoices, verificar que os totais calculados estão corretos (receita paga, pendente, atrasada)
- [x] Meta de cobertura: >= 60% de linhas nos três services (verificar com `npm run test:coverage`)

### OUT
- Testes de controllers (cobertos indiretamente por integração futura)
- Testes de middleware de auth
- Testes dos outros modules (reports, campaigns, etc.)
- Testes de integração com banco real

## Critérios de Aceitação
- [x] AC1: Dado que `npm run test` é executado, então todos os testes de auth, clients e finance passam sem erros
- [x] AC2: Dado que `npm run test:coverage` é executado, então a cobertura de linhas de `auth.service.ts`, `clients.service.ts` e `finance.service.ts` é >= 60%
- [x] AC3: Dado que os testes executam, então nenhum teste faz conexão com banco de dados real (verificado pelo mock do Prisma)
- [x] AC4: Dado que `auth.service.test.ts` testa o `register()`, então o teste verifica que a senha salva no banco é diferente da senha em plaintext (está hasheada)
- [x] AC5: Dado que `auth.service.test.ts` testa o `login()` com email inexistente, então o service lança erro com status 401 (não 500)
- [x] AC6: Os testes não dependem de variáveis de ambiente externas — quaisquer valores de `JWT_SECRET` ou `DATABASE_URL` necessários são definidos nos próprios arquivos de teste

## Dependências
Story 4.1 — Setup Jest + Supertest no backend (Jest configurado, scripts npm disponíveis).

## Arquivos Afetados
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\mocks\prisma.mock.ts` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\auth.service.test.ts` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\clients.service.test.ts` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\__tests__\finance.service.test.ts` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\auth\auth.service.ts` — leitura (sem modificações esperadas)
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\clients\clients.service.ts` — leitura (sem modificações esperadas)
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\finance\finance.service.ts` — leitura (sem modificações esperadas)

## Estimativa
G

## Change Log
- 2026-02-27: Story criada por @sm
- 2026-02-27: Validado por @po — GO 8/10. Status: Ready.
- 2026-02-27: Implementado por @dev — 27 testes criados (auth: 8, clients: 9, finance: 10). Todos passam. Status: InProgress.
- 2026-02-27: QA Gate por @qa — PASS. 7/7 checks OK. 28/28 testes passando. Todos os ACs confirmados. Status: Done.
