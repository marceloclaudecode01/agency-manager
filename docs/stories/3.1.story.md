# Story 3.1 — Export CSV para Relatórios (Receita por Período + Ranking de Clientes)

**Status:** Done
**Epic:** Exportação de Dados (PDF/CSV)
**Priority:** P1

## Descrição
Como administrador ou gerente da agência, quero exportar relatórios de receita e ranking de clientes em formato CSV para que eu possa analisar os dados em planilhas (Excel / Google Sheets).

## Contexto Técnico
O módulo de reports já possui `ReportsController` e `ReportsService` com os métodos `getRevenue(query)` e `getTopClients()`. Os endpoints existentes são:
- `GET /api/reports/revenue` — retorna dados de receita por período
- `GET /api/reports/clients/top` — retorna ranking de clientes

Esta story adiciona novos endpoints de export que reutilizam os mesmos services, mas formatam a saída como CSV em vez de JSON.

Geração do CSV: implementar manualmente (sem biblioteca extra) para manter leveza. Usar UTF-8 com BOM (`\uFEFF`) para compatibilidade com Excel. Separador `;`.

Proteção de role: o middleware de auth já suporta verificação de roles via `req.user.role`. Deve retornar 403 para `MEMBER`.

## Escopo

### IN
- [x] Novo endpoint `GET /api/reports/revenue/export?format=csv&startDate=YYYY-MM-DD&endDate=YYYY-MM-DD` no `reports.routes.ts`
- [x] Novo método `exportRevenueCsv(query)` em `reports.service.ts` que chama `getRevenue()` e converte para CSV
- [x] Novo endpoint `GET /api/reports/clients/export?format=csv` no `reports.routes.ts`
- [x] Novo método `exportClientsCsv()` em `reports.service.ts` que chama `getTopClients()` e converte para CSV
- [x] Novos métodos no `reports.controller.ts`: `exportRevenueCsv` e `exportClientsCsv`
- [x] Headers da resposta: `Content-Type: text/csv; charset=utf-8`, `Content-Disposition: attachment; filename="receita-<periodo>.csv"` / `filename="clientes-ranking.csv"`
- [x] Cabeçalho CSV de receita: `Período;Receita Total (R$);Faturas Pagas;Faturas Pendentes`
- [x] Cabeçalho CSV de clientes: `Cliente;Receita Total (R$);Número de Campanhas;Status`
- [x] Proteção por role: retornar 403 para `MEMBER` (usar middleware `authorize(['ADMIN', 'MANAGER'])` se existir, ou checar `req.user.role` no controller)
- [x] Frontend: botão "Exportar CSV" na página `/reports` que abre o endpoint via `window.open()` ou `<a href>` com token no header (usar query param `?token=` se necessário)

### OUT
- Export em outros formatos (XLSX, JSON)
- Export de relatórios de campanhas
- Agendamento de exports por email

## Critérios de Aceitação
- [x] AC1: Dado que um ADMIN faz `GET /api/reports/revenue/export?format=csv&startDate=2024-01-01&endDate=2024-12-31`, então a resposta tem `Content-Type: text/csv` e o corpo é um CSV válido com BOM e separador `;`
- [x] AC2: Dado que o CSV de receita é aberto no Excel, então os caracteres acentuados (ex: "Período") aparecem corretamente sem encoding quebrado
- [x] AC3: Dado que um usuário com role MEMBER chama qualquer endpoint de export, então a API retorna 403
- [x] AC4: Dado que um ADMIN clica em "Exportar CSV" na página de relatórios, então o browser inicia o download do arquivo `.csv` sem navegar para nova página
- [x] AC5: Dado que não existem dados no período selecionado, então o CSV é retornado apenas com o cabeçalho (sem linhas de dados) e status 200

## Dependências
Nenhuma (Epic 3 pode rodar em paralelo com Epic 2).

## Arquivos Afetados
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\reports\reports.controller.ts` — adicionados métodos exportRevenueCsv, exportClientsCsv com headers CSV
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\reports\reports.service.ts` — adicionados métodos exportRevenueCsv (query Prisma direta com contagem de faturas pagas/pendentes por mês) e exportClientsCsv
- `C:\Users\MARCELO SANTOS\Desktop\test\backend\src\modules\reports\reports.routes.ts` — adicionadas rotas GET /revenue/export e /clients/export (protegidas por requireRole existente)
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\app\(dashboard)\reports\page.tsx` — adicionados botões "Exportar CSV" com loading state, download via fetch+blob (autenticado por cookie de sessão)

## Estimativa
M

## Change Log
- 2026-02-27: Story criada por @sm
- 2026-02-27: Validado por @po — GO 8/10. Status: Ready.
- 2026-02-27: Implementado por @dev (Dex). Status: InReview. Backend: 2 novos endpoints export (revenue + clients) com CSV manual, BOM UTF-8, separador ponto-e-vírgula, proteção ADMIN/MANAGER via requireRole existente. Frontend: botões "Exportar CSV" com loading state, download via axios blob + anchor click programático.
- 2026-02-27: QA CONCERNS fixes por @dev — filtro paidAt/PAID no CSV receita, status real no CSV clientes
