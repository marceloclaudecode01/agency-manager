# Story 4.4 — Testes de Componentes: Login Form, Dashboard KPIs, Task Board

**Status:** Done
**Epic:** Cobertura de Testes
**Priority:** P2

## Descrição
Como desenvolvedor, quero testes dos componentes críticos de interface (login, formulário de cliente, auth context) para que regressões visuais e de fluxo sejam detectadas automaticamente.

## Contexto Técnico
Com Vitest e Testing Library configurados (Story 4.3), esta story escreve os testes de componentes.

Componentes a testar (mapeados para os arquivos do App Router):
- Formulário de Login: `frontend/src/app/(auth)/login/page.tsx` — Client Component (`'use client'`)
- Formulário de criação de Cliente: componente em `frontend/src/components/clients/` ou inline em `frontend/src/app/(dashboard)/clients/page.tsx`
- AuthContext / hook de autenticação: `frontend/src/contexts/` (AuthContext) e/ou `frontend/src/hooks/useAuth.ts`

O `api.ts` deve ser mockado via o mock criado em Story 4.3. O `next/navigation` (`useRouter`, `usePathname`) deve ser mockado via `vi.mock('next/navigation')` para evitar erros em ambiente jsdom.

O `AuthContext` provavelmente usa `localStorage` para persistir o token — mockar via `vi.stubGlobal('localStorage', ...)` ou usar a implementação real do jsdom.

## Escopo

### IN
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\__tests__\login.test.tsx`:
  - Teste 1: renderiza campos de email e senha
  - Teste 2: (N/A — login page não tem validação client-side, usa atributo HTML `required`)
  - Teste 3: exibe mensagem de erro da API ao receber resposta de erro
  - Teste 4: chama login() com email e senha corretos ao submeter
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\__tests__\client-form.test.tsx`:
  - Teste 1: campos do formulário são renderizados quando modal abre
  - Teste 2: submit com dados válidos chama `api.post('/clients', dadosCorretos)`
  - Teste 3: exibe toast de sucesso após criação bem-sucedida
  - Teste 4: exibe toast de erro quando api.post falha
- [x] Criar `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\__tests__\auth-context.test.tsx`:
  - Teste 1: estado inicial é `{ user: null, loading: true }` — então loading false após /auth/me
  - Teste 2: após `login()` bem-sucedido, `user` é definido e router.push('/dashboard') chamado
  - Teste 3: após `logout()`, `user` é null e router.push('/login') chamado
  - Teste 4: logout gracioso mesmo quando POST /auth/logout falha
- [x] Adicionar mock de `next/navigation` no `setup.ts`
- [x] Adicionar mock de `next/image` no `setup.ts`

### OUT
- Testes do TaskBoard / componentes do Kanban (cobertos indiretamente via e2e futuro — o Kanban é interativo demais para unit tests isolados serem de alto valor)
- Testes de componentes de layout (Sidebar, Header)
- Testes de KPIs do Dashboard (requerem dados mockados complexos de múltiplos endpoints)
- Testes e2e com Playwright ou Cypress

## Critérios de Aceitação
- [x] AC1: Dado que `npm run test` é executado, então todos os testes de `login.test.tsx`, `client-form.test.tsx` e `auth-context.test.tsx` passam
- [x] AC2: Dado que `login.test.tsx` testa o redirecionamento pós-login, `useAuth.login()` é chamado e router.push('/dashboard') é verificado em auth-context.test.tsx
- [x] AC3: Dado que `login.test.tsx` simula erro de API, então o componente exibe a mensagem de erro sem lançar exceção não tratada
- [x] AC4: Dado que `auth-context.test.tsx` chama `logout()`, então `user` é null e router.push('/login') é chamado (auth usa httpOnly cookie, não localStorage — sem removeItem)
- [x] AC5: Os testes não fazem requisições HTTP reais — todas as chamadas à API são interceptadas pelo mock de `api.ts`
- [x] AC6: O `vitest.config.ts` não precisa de modificações para esta story — todos os testes funcionam com a configuração da Story 4.3

## Dependências
Story 4.3 — Setup Vitest + Testing Library no frontend (Vitest configurado, mocks base disponíveis).

## Arquivos Afetados
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\__tests__\login.test.tsx` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\__tests__\client-form.test.tsx` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\__tests__\auth-context.test.tsx` — NOVO arquivo
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\__tests__\setup.ts` — possível adição de mocks de next/navigation e next/image
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\app\(auth)\login\page.tsx` — leitura (sem modificações esperadas)
- `C:\Users\MARCELO SANTOS\Desktop\test\frontend\src\contexts\` — leitura do AuthContext (sem modificações esperadas)

## Estimativa
G

## Change Log
- 2026-02-27: Story criada por @sm
- 2026-02-27: Validado por @po — GO 8/10. Status: Ready.
- 2026-02-27: Implementado por @dev (Dex). login.test.tsx, client-form.test.tsx, auth-context.test.tsx criados. Mocks de next/navigation e next/image no setup.ts. Status: InProgress.
- 2026-02-27: QA Gate por @qa — PASS. 7/7 checks OK. 15/15 testes frontend passando. Todos os ACs confirmados. Status: Done.
